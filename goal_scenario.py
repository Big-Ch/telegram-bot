"""
–ú–æ–¥—É–ª—å —Å—Ü–µ–Ω–∞—Ä–∏—è —Ü–µ–ª–µ–ø–æ–ª–∞–≥–∞–Ω–∏—è –Ω–∞ 12 –Ω–µ–¥–µ–ª—å
"""
from typing import List, Dict, Optional
from dataclasses import dataclass, asdict
from enum import Enum
import json
import logging

import llm_client

logger = logging.getLogger(__name__)


class ScenarioStage(Enum):
    """–≠—Ç–∞–ø—ã —Å—Ü–µ–Ω–∞—Ä–∏—è —Ü–µ–ª–µ–ø–æ–ª–∞–≥–∞–Ω–∏—è"""
    INTRODUCTION = "introduction"
    COLLECTING_GOALS = "collecting_goals"
    SELECTING_GOALS = "selecting_goals"
    DEFINING_SUCCESS_CRITERIA = "defining_success_criteria"
    PLANNING_INSTRUCTION = "planning_instruction"
    FINALIZATION = "finalization"
    COMPLETED = "completed"


@dataclass
class Goal:
    """–¶–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    text: str
    success_criteria: Optional[str] = None


@dataclass
class ScenarioState:
    """–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id: int
    stage: ScenarioStage
    all_goals: List[str]
    selected_goals: List[Goal]
    current_goal_index: int
    conversation_history: List[Dict[str, str]]
    
    def to_dict(self) -> Dict:
        """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î"""
        return {
            "user_id": self.user_id,
            "stage": self.stage.value,
            "all_goals": self.all_goals,
            "selected_goals": [{"text": g.text, "success_criteria": g.success_criteria} for g in self.selected_goals],
            "current_goal_index": self.current_goal_index,
            "conversation_history": self.conversation_history
        }
    
    @classmethod
    def from_dict(cls, data: Dict) -> "ScenarioState":
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è"""
        return cls(
            user_id=data["user_id"],
            stage=ScenarioStage(data["stage"]),
            all_goals=data["all_goals"],
            selected_goals=[Goal(text=g["text"], success_criteria=g.get("success_criteria")) for g in data["selected_goals"]],
            current_goal_index=data["current_goal_index"],
            conversation_history=data.get("conversation_history", [])
        )


class GoalSettingScenario:
    """–ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–º —Ü–µ–ª–µ–ø–æ–ª–∞–≥–∞–Ω–∏—è –Ω–∞ 12 –Ω–µ–¥–µ–ª—å"""
    
    def __init__(self, llm_client_instance: Optional[llm_client.LLMClient] = None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è
        
        Args:
            llm_client_instance: –≠–∫–∑–µ–º–ø–ª—è—Ä LLM –∫–ª–∏–µ–Ω—Ç–∞. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.
                                 –ï—Å–ª–∏ None –ø–µ—Ä–µ–¥–∞–Ω–æ —è–≤–Ω–æ, LLM –Ω–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.
        """
        if llm_client_instance is None:
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç
            try:
                self.llm = llm_client.get_llm_client()
            except (ValueError, Exception):
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, LLM –±—É–¥–µ—Ç None (–±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback)
                self.llm = None
        else:
            self.llm = llm_client_instance
    
    def get_introduction_message(self) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –≤–≤–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è"""
        return (
            "üéØ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —Ü–µ–ª–µ–ø–æ–ª–∞–≥–∞–Ω–∏—è –Ω–∞ 12 –Ω–µ–¥–µ–ª—å!</b>\n\n"
            "–≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ:\n"
            "‚Ä¢ –°—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 3 –º–µ—Å—è—Ü–∞\n"
            "‚Ä¢ –í—ã–±—Ä–∞—Ç—å —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –∏–∑ –Ω–∏—Ö\n"
            "‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ç–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞\n"
            "‚Ä¢ –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è\n\n"
            "–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? –ü–æ–µ—Ö–∞–ª–∏! üöÄ\n\n"
            "<b>–®–∞–≥ 1: –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–µ–π</b>\n\n"
            "–ü–æ–¥—É–º–∞–π –æ —Ç–æ–º, —á–µ–≥–æ —Ç—ã —Ö–æ—á–µ—à—å –¥–æ—Å—Ç–∏—á—å –≤ –±–ª–∏–∂–∞–π—à–∏–µ 3 –º–µ—Å—è—Ü–∞. "
            "–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∏ –≤–≤–µ–¥–∏ —Å–≤–æ–∏ —Ü–µ–ª–∏ (–¥–æ 10 —Ü–µ–ª–µ–π).\n\n"
            "<i>–ü—Ä–∏–º–µ—Ä—ã:</i>\n"
            "‚Ä¢ –ö–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç (–ø–æ–ª—É—á–∏—Ç—å –ø–æ–≤—ã—à–µ–Ω–∏–µ)\n"
            "‚Ä¢ –†–∞–Ω–Ω–∏–π –ø–æ–¥—ä–µ–º (–≤—Å—Ç–∞–≤–∞—Ç—å –≤ 7 —É—Ç—Ä–∞)\n"
            "‚Ä¢ –ü–æ—Ö—É–¥–µ–Ω–∏–µ (—Å–±—Ä–æ—Å–∏—Ç—å 5 –∫–≥)\n"
            "‚Ä¢ –ò–∑—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —è–∑—ã–∫–∞\n"
            "‚Ä¢ –†–∞–∑–≤–∏—Ç–∏–µ –Ω–∞–≤—ã–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è\n\n"
            "–í–≤–µ–¥–∏ —Å–≤–æ–∏ —Ü–µ–ª–∏ –ø–æ –æ–¥–Ω–æ–π, –∏–ª–∏ –≤—Å–µ —Å—Ä–∞–∑—É —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. "
            "–ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å, –Ω–∞–ø–∏—à–∏ <b>\"–ì–æ—Ç–æ–≤–æ\"</b> –∏–ª–∏ <b>\"–ó–∞–≤–µ—Ä—à–∏—Ç—å\"</b>."
        )
    
    async def process_goals_input(self, user_input: str, current_goals: List[str]) -> tuple[str, List[str], bool]:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ü–µ–ª–µ–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_input: –í–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            current_goals: –¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π
        
        Returns:
            –ö–æ—Ä—Ç–µ–∂ (—Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π, –∑–∞–≤–µ—Ä—à–µ–Ω–æ –ª–∏ –≤–≤–µ–¥–µ–Ω–∏–µ)
        """
        user_input_lower = user_input.lower().strip()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        if user_input_lower in ["–≥–æ—Ç–æ–≤–æ", "–∑–∞–≤–µ—Ä—à–∏—Ç—å", "–≥–æ—Ç–æ–≤", "–∑–∞–∫–æ–Ω—á–∏—Ç—å", "/done"]:
            if len(current_goals) == 0:
                return (
                    "‚ùå –¢—ã –µ—â–µ –Ω–µ –≤–≤–µ–ª –Ω–∏ –æ–¥–Ω–æ–π —Ü–µ–ª–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–µ–ª—å –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º.",
                    current_goals,
                    False
                )
            return (
                f"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –¢—ã –≤–≤–µ–ª {len(current_goals)} {'—Ü–µ–ª–µ–π' if len(current_goals) > 1 else '—Ü–µ–ª—å'}.\n\n"
                "–î–∞–≤–∞–π –ø–µ—Ä–µ–π–¥–µ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É!",
                current_goals,
                True
            )
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–ª–µ–π –∏–∑ –≤–≤–æ–¥–∞
        new_goals = []
        # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º –∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º —Å—Ç—Ä–æ–∫
        lines = user_input.replace(",", "\n").split("\n")
        
        for line in lines:
            goal = line.strip()
            if goal and goal not in current_goals:
                new_goals.append(goal)
                current_goals.append(goal)
        
        if len(current_goals) >= 10:
            return (
                f"‚úÖ –ü—Ä–∏–Ω—è—Ç–æ! –¢—ã –≤–≤–µ–ª –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–µ–ª–µ–π (10).\n\n"
                f"–í—Å–µ–≥–æ —Ü–µ–ª–µ–π: {len(current_goals)}\n\n"
                "–ú–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å <b>\"–ì–æ—Ç–æ–≤–æ\"</b> –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É, "
                "–∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–≤–æ–¥ (–Ω–æ —É—á—Ç–µ–Ω—ã –±—É–¥—É—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10).",
                current_goals[:10],
                False
            )
        
        if new_goals:
            return (
                f"‚úÖ –¶–µ–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã! –í—Å–µ–≥–æ —Ü–µ–ª–µ–π: {len(current_goals)}/10\n\n"
                "–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤–≤–æ–¥–∏—Ç—å —Ü–µ–ª–∏ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ <b>\"–ì–æ—Ç–æ–≤–æ\"</b> –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É.",
                current_goals,
                False
            )
        else:
            return (
                "‚ÑπÔ∏è –≠—Ç–∞ —Ü–µ–ª—å —É–∂–µ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–ª–∏ –≤–≤–µ–¥–µ–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. "
                "–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤–≤–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ —Ü–µ–ª–∏ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ <b>\"–ì–æ—Ç–æ–≤–æ\"</b>.",
                current_goals,
                False
            )
    
    def get_goals_selection_message(self, goals: List[str]) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–µ–π"""
        goals_text = "\n".join([f"{i+1}. {goal}" for i, goal in enumerate(goals)])
        return (
            f"üìã <b>–í—Å–µ —Ç–≤–æ–∏ —Ü–µ–ª–∏:</b>\n\n{goals_text}\n\n"
            "<b>–®–∞–≥ 2: –§–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞</b>\n\n"
            "–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å 3 —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ —Ü–µ–ª–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã.\n\n"
            "–í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä–∞ —Ü–µ–ª–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –ø—Ä–æ–±–µ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1, 3, 5 –∏–ª–∏ 1 3 5)"
        )
    
    def process_goals_selection(self, user_input: str, all_goals: List[str]) -> tuple[str, List[str], bool]:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        
        Args:
            user_input: –í–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–æ–º–µ—Ä–∞ —Ü–µ–ª–µ–π)
            all_goals: –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π
        
        Returns:
            –ö–æ—Ä—Ç–µ–∂ (—Å–æ–æ–±—â–µ–Ω–∏–µ, –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–µ–ª–∏, —É—Å–ø–µ—à–Ω–æ –ª–∏ –≤—ã–±—Ä–∞–Ω–æ)
        """
        try:
            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤
            numbers = []
            for part in user_input.replace(",", " ").split():
                if part.isdigit():
                    num = int(part)
                    if 1 <= num <= len(all_goals):
                        numbers.append(num - 1)  # –ò–Ω–¥–µ–∫—Å—ã —Å 0
            
            # –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ—Ä—è–¥–∫–∞
            numbers = list(dict.fromkeys(numbers))
            
            if len(numbers) == 0:
                return (
                    f"‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –Ω–æ–º–µ—Ä–∞ —Ü–µ–ª–µ–π –æ—Ç 1 –¥–æ {len(all_goals)}. "
                    "–ù–∞–ø—Ä–∏–º–µ—Ä: 1, 2, 3",
                    [],
                    False
                )
            
            if len(numbers) > 3:
                numbers = numbers[:3]
                message = f"‚ö†Ô∏è –í—ã–±—Ä–∞–Ω–æ –±–æ–ª—å—à–µ 3 —Ü–µ–ª–µ–π. –ë—É–¥—É—Ç —É—á—Ç–µ–Ω—ã –ø–µ—Ä–≤—ã–µ 3.\n\n"
            elif len(numbers) < 3:
                return (
                    f"‚ùå –ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ä–æ–≤–Ω–æ 3 —Ü–µ–ª–∏. –¢—ã –≤—ã–±—Ä–∞–ª {len(numbers)}. "
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –µ—â–µ —Ü–µ–ª–∏ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏ –≤—ã–±–æ—Ä –∑–∞–Ω–æ–≤–æ.",
                    [],
                    False
                )
            else:
                message = ""
            
            selected_goals = [all_goals[i] for i in numbers]
            goals_text = "\n".join([f"‚Ä¢ {goal}" for goal in selected_goals])
            
            return (
                f"{message}‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í—ã–±—Ä–∞–Ω—ã 3 –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ü–µ–ª–∏:\n\n{goals_text}\n\n"
                "–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É!",
                selected_goals,
                True
            )
        except Exception as e:
            return (
                f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤—ã–±–æ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –Ω–æ–º–µ—Ä–∞ —Ü–µ–ª–µ–π —Å–Ω–æ–≤–∞. "
                f"–ù–∞–ø—Ä–∏–º–µ—Ä: 1, 2, 3",
                [],
                False
            )
    
    async def get_success_criteria_prompt(self, goal: str, goal_number: int, total_goals: int) -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–º–ø—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫—Ä–∏—Ç–µ—Ä–∏—è —É—Å–ø–µ—Ö–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM
        
        Args:
            goal: –¢–µ–∫—Å—Ç —Ü–µ–ª–∏
            goal_number: –ù–æ–º–µ—Ä —Ü–µ–ª–∏ (1, 2, 3)
            total_goals: –í—Å–µ–≥–æ —Ü–µ–ª–µ–π (–æ–±—ã—á–Ω–æ 3)
        
        Returns:
            –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –∫—Ä–∏—Ç–µ—Ä–∏—è —É—Å–ø–µ—Ö–∞
        """
        system_prompt = (
            "–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Ü–µ–ª–µ–ø–æ–ª–∞–≥–∞–Ω–∏—é. –ü–æ–º–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ç–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –¥–ª—è –µ–≥–æ —Ü–µ–ª–∏. "
            "–ö—Ä–∏—Ç–µ—Ä–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑–º–µ—Ä–∏–º—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º."
        )
        
        user_prompt = (
            f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥ —Ü–µ–ª—å—é: '{goal}' (—Ü–µ–ª—å {goal_number} –∏–∑ {total_goals}). "
            "–ù—É–∂–Ω–æ –ø–æ–º–æ—á—å –µ–º—É —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞. "
            "–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–ø—Ä–æ—Å–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, "
            "–∫–∞–∫ –æ–Ω –ø–æ–π–º–µ—Ç, —á—Ç–æ —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞. –ü—Ä–∏–≤–µ–¥–∏ 1-2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –¥–ª—è —ç—Ç–æ–π —Ü–µ–ª–∏. "
            "–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∏ –º–∞–∫—Å–∏–º—É–º 150 —Å–ª–æ–≤."
        )
        
        # –ï—Å–ª–∏ LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
        if self.llm is None:
            pass  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ fallback
        else:
            try:
                llm_response = await self.llm.generate_response(
                    user_message=user_prompt,
                    system_prompt=system_prompt,
                    temperature=0.8,
                    max_tokens=200
                )
                return llm_response
            except Exception as e:
                logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ LLM: {e}, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback")
        
        # Fallback —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–ª–∏ –æ—à–∏–±–∫–∏ LLM
        try:
            # Fallback —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ LLM
            examples = {
                "–∫–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç": "–ø–æ–ª—É—á–∏–ª –Ω–æ–≤—É—é –¥–æ–ª–∂–Ω–æ—Å—Ç—å",
                "—Ä–∞–Ω–Ω–∏–π –ø–æ–¥—ä–µ–º": "–≤—Å—Ç–∞—é –≤ 7 —É—Ç—Ä–∞ –±–µ–∑ –±—É–¥–∏–ª—å–Ω–∏–∫–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é",
                "–ø–æ—Ö—É–¥–µ–Ω–∏–µ": "–ø–æ—Ö—É–¥–µ–ª –Ω–∞ 5 –∫–≥"
            }
            
            example = ""
            for key, value in examples.items():
                if key in goal.lower():
                    example = f"–ù–∞–ø—Ä–∏–º–µ—Ä: '{value}'"
                    break
            
            if not example:
                example = "–ù–∞–ø—Ä–∏–º–µ—Ä: '–ø–æ–ª—É—á–∏–ª –Ω–æ–≤—É—é –¥–æ–ª–∂–Ω–æ—Å—Ç—å' –∏–ª–∏ '–≤—Å—Ç–∞—é –≤ 7 —É—Ç—Ä–∞ –±–µ–∑ –±—É–¥–∏–ª—å–Ω–∏–∫–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é'"
            
            return (
                f"<b>–®–∞–≥ 3: –ö–æ–Ω–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</b>\n\n"
                f"üéØ <b>–¶–µ–ª—å {goal_number} –∏–∑ {total_goals}: {goal}</b>\n\n"
                f"–ö–∞–∫ —Ç—ã –ø–æ–π–º–µ—à—å, —á—Ç–æ —ç—Ç–∞ —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞? "
                f"–û–ø–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–ª–∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π).\n\n"
                f"<i>{example}</i>"
            )
    
    def get_planning_instruction_message(self) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é"""
        return (
            "üìö <b>–®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –¥–µ–π—Å—Ç–≤–∏–π</b>\n\n"
            "–¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è –µ—Å—Ç—å 3 —á–µ—Ç–∫–∏–µ —Ü–µ–ª–∏ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ —É—Å–ø–µ—Ö–∞. "
            "–í–æ—Ç –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö SMART:\n\n"
            "<b>–®–∞–≥ 1:</b> –ß–µ—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª–∏ 1-3 –∫–ª—é—á–µ–≤—ã–µ —Ü–µ–ª–∏ –Ω–∞ 12 –Ω–µ–¥–µ–ª—å (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ ‚úÖ)\n\n"
            "<b>–®–∞–≥ 2:</b> –î–µ–∫–æ–º–ø–æ–∑–∏—Ä—É–π –∫–∞–∂–¥—É—é —Ü–µ–ª—å –Ω–∞ —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —à–∞–≥–∏\n"
            "   ‚Ä¢ –†–∞–∑–±–µ–π –±–æ–ª—å—à–∏–µ —Ü–µ–ª–∏ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ –∑–∞–¥–∞—á–∏\n"
            "   ‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é\n"
            "   ‚Ä¢ –ü–ª–∞–Ω–∏—Ä—É–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è\n\n"
            "<b>–®–∞–≥ 3:</b> –ó–∞–±–ª–æ–∫–∏—Ä—É–π –≤—Ä–µ–º—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ –∑–∞–¥–∞—á–∏\n"
            "   ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 3-4 —á–∞—Å–∞ —Ñ–æ–∫—É—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤ –¥–µ–Ω—å\n"
            "   ‚Ä¢ –í—ã–¥–µ–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –∫–∞–∂–¥–æ–π —Ü–µ–ª—å—é\n\n"
            "<b>–®–∞–≥ 4:</b> –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π –¥–µ–π—Å—Ç–≤–∏—è\n"
            "   ‚Ä¢ –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–∏ –ø—Ä–æ–≤–µ—Ä—è–π, —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ\n"
            "   ‚Ä¢ –ê–¥–∞–ø—Ç–∏—Ä—É–π –ø–ª–∞–Ω –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\n\n"
            "<b>–®–∞–≥ 5:</b> –ü–æ –∏—Ç–æ–≥–∞–º 12 –Ω–µ–¥–µ–ª—å –ø—Ä–æ–≤–µ–¥–∏ –æ—Ü–µ–Ω–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n"
            "   ‚Ä¢ –ß—Ç–æ —É–¥–∞–ª–æ—Å—å –¥–æ—Å—Ç–∏—á—å?\n"
            "   ‚Ä¢ –ö–∞–∫–∏–µ –±—ã–ª–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è?\n"
            "   ‚Ä¢ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ?\n\n"
            "<b>–®–∞–≥ 6:</b> –ù–∞—á–Ω–∏ –Ω–æ–≤—ã–π 12-–Ω–µ–¥–µ–ª—å–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è üîÑ\n\n"
            "üí° –ü–æ–º–Ω–∏: —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ - –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É!"
        )
    
    def get_finalization_message(self, selected_goals: List[Goal]) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏—Ç–æ–≥–∞–º–∏"""
        goals_summary = "\n".join([
            f"‚Ä¢ <b>{goal.text}</b>\n  –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞: {goal.success_criteria or '–ù–µ —É–∫–∞–∑–∞–Ω'}"
            for goal in selected_goals
        ])
        
        return (
            "üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω!</b>\n\n"
            f"üìã <b>–¢–≤–æ–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ü–µ–ª–∏ –Ω–∞ 12 –Ω–µ–¥–µ–ª—å:</b>\n\n{goals_summary}\n\n"
            "–¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è –µ—Å—Ç—å:\n"
            "‚úÖ 3 —á–µ—Ç–∫–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ü–µ–ª–∏\n"
            "‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏\n"
            "‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\n\n"
            "<b>–ì–æ—Ç–æ–≤ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ?</b>\n\n"
            "–•–æ—á–µ—à—å –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è? üéØ\n"
            "–ò–ª–∏ –Ω—É–∂–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∫–æ—É—á–∞? üíº\n\n"
            "–ù–∞–ø–∏—à–∏, —á—Ç–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç!"
        )

